<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <title>ML-micro:bit 2026</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8.5/dist/teachablemachine-image.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8.5/dist/teachablemachine-pose.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>

     <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; font-family: sans-serif; background-color: #f4f4f9; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .setup-box { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 85%; max-width: 360px; text-align: center; }
        input { width: 100%; padding: 15px; border: 2px solid #bbb; border-radius: 12px; margin-bottom: 20px; font-size: 16px; box-sizing: border-box; }
        button { width: 100%; padding: 20px; font-size: 18px; font-weight: 900; background: #28a745; color: white; border: none; border-radius: 15px; cursor: pointer; text-transform: uppercase; }
        #webcam-container { margin: 20px auto; border: 5px solid #333; border-radius: 20px; overflow: hidden; display: none; width: 224px; height: 224px; }
        #audio-visualizer { display: none; justify-content: center; align-items: flex-end; gap: 8px; height: 80px; margin: 20px; }
        .bar { width: 12px; height: 20px; background-color: #007bff; border-radius: 5px; transition: transform 0.1s; transform-origin: bottom; }
        #label-container { font-size: 32px; font-weight: 900; margin-top: 10px; text-align: center; }
    </style>
</head>
<body>

    <h1>ML-micro:bit</h1>

    <div class="setup-box" id="setup-ui">
        <p>URL de Teachable Machine:</p>
        <input type="text" id="model-url" placeholder="https://teachablemachine..." />
        <button onclick="init()">Conectar e Iniciar</button>
    </div>
    
    <div id="webcam-container"></div>

    <div id="audio-visualizer">
        <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
    </div>

    <div id="label-container">Listo</div>

    <script>
        let model, webcam, recognizer, uartCharacteristic, bleDevice;
        let lastPrediction = "";
        let modelType = "";

        async function detectModelType(baseUrl) {
            try {
                const response = await fetch(baseUrl + "metadata.json");
                const data = await response.json();
                return data.wordLabels ? "audio" : "image";
            } catch (e) { return "image"; }
        }

        async function init() {
            const urlInput = document.getElementById("model-url").value.trim();
            if (!urlInput.includes("teachablemachine.withgoogle.com")) return alert("URL no válida");

            const TM_URL = urlInput.endsWith("/") ? urlInput : urlInput + "/";
            
            try {
                modelType = await detectModelType(TM_URL);
                
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'BBC micro:bit' }, { namePrefix: 'micro:bit' }],
                    optionalServices: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e']
                });

                const server = await bleDevice.gatt.connect();
                const service = await server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');
                // Usamos 0003 que es el que confirmaste que funciona para recibir en tu placa
                uartCharacteristic = await service.getCharacteristic('6e400003-b5a3-f393-e0a9-e50e24dcca9e');

                document.getElementById("setup-ui").style.display = "none";

                if (modelType === "audio") {
                    document.getElementById("audio-visualizer").style.display = "flex";
                    startAudioML(TM_URL);
                } else {
                    document.getElementById("webcam-container").style.display = "block";
                    startImageML(TM_URL);
                }
            } catch (err) { alert("Error de conexión"); }
        }

        async function startImageML(url) {
            model = await tmImage.load(url + "model.json", url + "metadata.json");
            webcam = new tmImage.Webcam(224, 224, true);
            await webcam.setup();
            await webcam.play();
            document.getElementById("webcam-container").appendChild(webcam.canvas);
            loop();
        }

        async function loop() {
            webcam.update();
            const prediction = await model.predict(webcam.canvas);
            processPredictions(prediction);
            window.requestAnimationFrame(loop);
        }

        async function startAudioML(url) {
            recognizer = speechCommands.create("BROWSER_FFT", undefined, url + "model.json", url + "metadata.json");
            await recognizer.ensureModelLoaded();
            recognizer.listen(result => {
                const labels = recognizer.wordLabels();
                let highIdx = result.scores.indexOf(Math.max(...result.scores));
                let score = result.scores[highIdx];
                
                document.querySelectorAll('.bar').forEach(b => {
                    b.style.transform = `scaleY(${(score * 2.5) + Math.random()})`;
                });

                if (score > 0.85 && labels[highIdx] !== "Background Noise") {
                    updateLabelAndSend(labels[highIdx]);
                }
            }, { probabilityThreshold: 0.85 });
        }

        function processPredictions(predictions) {
            for (let p of predictions) {
                if (p.probability > 0.90 && p.className !== lastPrediction) {
                    updateLabelAndSend(p.className);
                }
            }
        }

        function updateLabelAndSend(name) {
            lastPrediction = name;
            document.getElementById("label-container").innerText = name;
            if (uartCharacteristic && bleDevice.gatt.connected) {
                const encoder = new TextEncoder();
                uartCharacteristic.writeValue(encoder.encode(name + "\n")).catch(e => console.log(e));
            }
        }
    </script>
</body>
</html>
